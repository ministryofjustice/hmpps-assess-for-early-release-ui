{% extends "layout.njk" %}
{% from "../../partials/card.njk" import card %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}

{% set pageTitle = "Assessing a licence - Caseload - " + applicationName %}
{% set toWorkOnByYouRows = [] %}
{% set postponedRows = [] %}

{% macro offenderName(offender, index) %}
    <a id="name-button-{{ index }}" href="{{ offender.createLink }}" class="govuk-link govuk-link--no-visited-state">{{ offender.name }}</a>
    <br>
    <div class="govuk-hint govuk-!-font-size-16">
        Prison number: {{ offender.prisonNumber }}
    </div>
{% endmacro %}

{% for offender in toWorkOnByYouCases %}
    {% set toWorkOnByYouRows = (toWorkOnByYouRows.push([
        {
            attributes: {
                id: 'name-' + loop.index,
                "data-sort-value": offender.name
            },
            html: offenderName(offender, loop.index)
        },
        {
            attributes: {
                id: 'hdced-' + loop.index,
                "data-sort-value": offender.hdced | toMillis
            },
            html: offender.hdced | formatDate('dd MMM yyyy')
        },
        {
            attributes: {
                id: 'remaining-days-' + loop.index,
                "data-sort-value": offender.remainingDays
            },
            html: offender.remainingDays
        }
    ]), toWorkOnByYouRows) %}
{% endfor %}

{% set toWorkOnByYou %}
    <h2 class="govuk-heading-l">To work on by you</h2>
    {{ govukTable({
        attributes: {
            'data-module': 'moj-sortable-table'
        },
        caption: "Caseload to work on by you",
        captionClasses: "govuk-visually-hidden",
        head: [{
            text: "Name",
            attributes: {
                "aria-sort": "none"
            }
        },
        {
            text: "HDCED",
            attributes: {
                "aria-sort": "none"
            }
        },
        {
            text: "Remaining days",
            attributes: {
                "aria-sort": "none"
            }
        }],
        rows: toWorkOnByYouRows
    }) }}

    {% for case in postponedCases %}
        {% set postponedRows = (postponedRows.push([
            {
                attributes: {
                    id: 'name-' + loop.index,
                    "data-sort-value": case.name
                },
                html: offenderName(case, loop.index)
            },
            {
                attributes: {
                    id: 'com-' + loop.index,
                    "data-sort-value": case.probationPractitioner
                },
                text: case.probationPractitioner
            },
            {
                attributes: {
                    id: 'hdced-' + loop.index,
                    "data-sort-value": case.hdced | toMillis
                },
                text: case.hdced | formatDate('dd MMM yyyy')
            },
            {
                attributes: {
                    id: 'remainingDays-' + loop.index,
                    "data-sort-value": case.remainingDays
                },
                text: case.remainingDays
            },
            {
                attributes: {
                    id: 'postponed-on-' + loop.index,
                    "data-sort-value": case.postponementDate
                },
                text: case.postponementDate | formatDate('dd MMM yyyy')
            },
            {
                attributes: {
                    id: 'postponementReason-' + loop.index,
                    "data-sort-value": case.postponementReason
                },
                text: case.postponementReason
            }
        ]), postponedRows) %}
    {% endfor %}

    {% set postponed %}
        <h2 class="govuk-heading-l">Postponed</h2>
        {{ govukTable({
            attributes: {
                'data-module': 'moj-sortable-table'
            },
            caption: "Postponed caseload",
            captionClasses: "govuk-visually-hidden",
            head: [{
                text: "Name",
                attributes: {
                    "aria-sort": "none"
                }
            },
            {
                text: "Probation practitioner",
                attributes: {
                    "aria-sort": "none"
                }
            },
            {
                text: "HDCED",
                attributes: {
                    "aria-sort": "none"
                }
            },
            {
                text: "Working days to HDCED",
                attributes: {
                    "aria-sort": "none"
                }
            },
            {
                text: "Postponed on",
                attributes: {
                    "aria-sort": "none"
                }
            },
            {
                text: "Postponement reason",
                attributes: {
                    "aria-sort": "none"
                }
            }],
            rows: postponedRows
        }) }}
    {% endset %}
{% endset %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-l">Select someone's HDC application to work on</h1>
            {{ govukTabs({
                items: [
                    {
                        id: "to-work-on-by-you",
                        label: "To work on by you",
                        attributes: {
                            "data-qa": "to-work-on-by-you"
                        },
                        panel: {
                            html: toWorkOnByYou
                        }
                    },
                    {
                        id: "postponed",
                        label: "Postponed",
                        attributes: {
                            "data-qa": "postponed"
                        },
                        panel: {
                            html: postponed
                        }
                    }
                ]
            }) }}
        </div>
    </div>
{% endblock %}
