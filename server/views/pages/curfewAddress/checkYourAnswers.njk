{% extends "layout.njk" %}
{% from "partials/offenderSummary.njk" import offenderSummary %}
{% from "partials/assessment/addressSummary.njk" import addressSummary %}
{% from "partials/assessment/residentSummary.njk" import residentSummary %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageTitle = applicationName + " - Check your answers" %}
{% set backLinkHref = "/" %}
{% set addressCount = addressSummary.length %}
{% set preferedAddress = checkRequestsForassessmentSummary | filter('preferencePriority', 'FIRST') %}
{% set secondAddress = checkRequestsForassessmentSummary | filter('preferencePriority', 'SECOND') %}
{%  macro getRemoveAddressLink(requestId) %}
    {{ paths.prison.assessment.curfewAddress.deleteCheckYourAnswers | toPath({ 
                            checkRequestId: requestId | safeToString,
                            prisonNumber: assessmentSummary.prisonNumber
                            }) }}
{% endmacro %}

{%  macro getChangeAddressLink(requestId) %}
    {{ paths.prison.assessment.curfewAddress.addResidentDetails | toPath({
                                checkRequestId: requestId | safeToString,
                                prisonNumber: assessmentSummary.prisonNumber
                                }) }}
{% endmacro %}

{% block content %}
    <div class="govuk-grid-row">
            {% include 'partials/errorSummary.njk' %}
            {{ offenderSummary(assessmentSummary.prisonNumber, assessmentSummary.hdced, assessmentSummary.dateOfBirth, assessmentSummary | toFullName) }}

        <form method="POST">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <h1 class="govuk-heading-l govuk-!-margin-top-6">
                        Check your answers
                    </h1>

                    <h2 class="govuk-heading-m govuk-!-margin-top-6">Preferred address</h2>
                    {{ addressSummary({ assessmentSummary: preferedAddress, 
                    links: [{ href: getChangeAddressLink(preferedAddress[0].requestId), text: "Change", visuallyHiddenText: "change address"}, 
                    { href: getRemoveAddressLink(preferedAddress[0].requestId), text: "Remove preferred address", visuallyHiddenText: "remove address"}]}) }}

                    <h3 class="govuk-heading-s govuk-!-margin-top-6">Details of residents</h3>
                    {% for resident in preferedAddress[0].residents %}
                        {{ residentSummary({ resident: resident, 
                        links: [{ href: getChangeAddressLink(preferedAddress[0].requestId), text: "Change", visuallyHiddenText: "change residents"}]}) }}
                    {% endfor %}


                    {% if secondAddress.length %}
                        <h2 class="govuk-heading-m govuk-!-margin-top-9">Second address</h2>
                        {{ addressSummary({ assessmentSummary: secondAddress, 
                        links: [{ href: getChangeAddressLink(secondAddress[0].requestId), text: "Change", visuallyHiddenText: "change address"}, 
                        { href: getRemoveAddressLink(secondAddress[0].requestId), text: "Remove second address", visuallyHiddenText: "remove address"}]}) }}

                        <h3 class="govuk-heading-s govuk-!-margin-top-6">Details of residents</h3>
                        {% for resident in secondAddress[0].residents %}
                            {{ residentSummary({ resident: resident, 
                            links: [{ href: getChangeAddressLink(secondAddress[0].requestId), text: "Change", visuallyHiddenText: "change residents"}]}) }}
                        {% endfor %}
                    {% endif %}

                     {{ govukButton({
                            text: "Save",
                            type: "submit",
                            attributes: { 'data-qa': 'save' }
                        }) }}
                </div>
            </div>
        </form>
    </div>
{% endblock %}
